<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reconhecimento do Alfabeto em Libras</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        header {
            text-align: center;
            color: #0066cc;
        }
        header p {
            color: #666;
            margin-top: -10px;
        }
        .video-container {
            width: 100%;
            background-color: #000;
            display: flex;
            justify-content: center;
            border-radius: 5px;
            margin: 20px 0;
            position: relative;
        }
        #video {
            width: 100%;
            height: auto;
            max-height: 400px;
            border-radius: 5px;
        }
        .camera-status {
            text-align: center;
            color: #28a745;
            margin: 10px 0;
            font-weight: 500;
        }
        .btn-container {
            text-align: center;
            margin: 10px 0;
        }
        .btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
        }
        .btn:hover {
            background-color: #5a6268;
        }
        .letter-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        .letter-box {
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #0066cc;
            border-radius: 8px;
            font-size: 48px;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 10px;
        }
        .letter-instruction {
            text-align: center;
            margin-bottom: 5px;
        }
        .letter-recognized {
            font-weight: bold;
            color: #333;
        }
        .instructions {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .instructions h2 {
            color: #0066cc;
            margin-top: 0;
        }
        .instructions ol {
            padding-left: 25px;
        }
        .instructions li {
            margin-bottom: 10px;
            color: #444;
        }
        .alphabet-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .alphabet-letter {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #0066cc;
            border-radius: 4px;
            font-weight: bold;
            color: #0066cc;
            cursor: pointer;
            transition: all 0.2s;
        }
        .alphabet-letter:hover {
            background-color: #e6f0ff;
        }
        .alphabet-letter.active {
            background-color: #0066cc;
            color: white;
        }
        .footer {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 30px;
        }
        #letterToShow {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        #recognizedLetter {
            font-weight: bold;
            font-size: 20px;
        }
        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            display: none;
        }
        #serverStatus {
            background-color: #e2f3e2;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Reconhecimento do Alfabeto em Libras</h1>
            <p>Aprenda e pratique o alfabeto da Língua Brasileira de Sinais</p>
        </header>

        <div id="serverStatus"></div>
        <div class="error-message" id="errorMessage"></div>

        <div class="video-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display: none;"></canvas>
            <img id="processedImage" style="width: 100%; height: auto; max-height: 400px; border-radius: 5px;" alt="Imagem processada">
        </div>

        <div class="camera-status" id="cameraStatus">Aguardando câmera...</div>

        <div class="btn-container">
            <button id="startBtn" class="btn">Iniciar Reconhecimento</button>
            <button id="pauseBtn" class="btn" style="display: none;">Pausar</button>
            <button id="testConnectionBtn" class="btn">Verificar Conexão</button>
        </div>

        <div class="letter-display">
            <div class="letter-box" id="detectedLetter"></div>
            <div class="letter-instruction">Faça um sinal para reconhecer</div>
            <div class="letter-recognized">Letra reconhecida: <span id="recognizedLetter"></span></div>
        </div>
    </div>

    <div class="container instructions">
        <h2>Como usar:</h2>
        <ol>
            <li>Clique em "Iniciar Reconhecimento" para ativar a câmera</li>
            <li>Posicione sua mão no centro da imagem</li>
            <li>Faça os sinais do alfabeto em Libras</li>
            <li>A letra correspondente será exibida na tela</li>
            <li>Use o grid abaixo para praticar todas as letras</li>
        </ol>
    </div>

    <div class="container">
        <h3 style="text-align: center;">Escolha uma letra para praticar:</h3>
        <div id="letterToShow"></div>
        <div class="alphabet-grid">
            <div class="alphabet-letter" data-letter="A">A</div>
            <div class="alphabet-letter" data-letter="B">B</div>
            <div class="alphabet-letter" data-letter="C">C</div>
            <div class="alphabet-letter" data-letter="D">D</div>
            <div class="alphabet-letter" data-letter="E">E</div>
            <div class="alphabet-letter" data-letter="F">F</div>
            <div class="alphabet-letter" data-letter="G">G</div>
            <div class="alphabet-letter" data-letter="I">I</div>
            <div class="alphabet-letter" data-letter="L">L</div>
            <div class="alphabet-letter" data-letter="M">M</div>
            <div class="alphabet-letter" data-letter="N">N</div>
            <div class="alphabet-letter" data-letter="O">O</div>
            <div class="alphabet-letter" data-letter="P">P</div>
            <div class="alphabet-letter" data-letter="R">R</div>
            <div class="alphabet-letter" data-letter="S">S</div>
            <div class="alphabet-letter" data-letter="T">T</div>
            <div class="alphabet-letter" data-letter="U">U</div>
            <div class="alphabet-letter" data-letter="V">V</div>
            <div class="alphabet-letter" data-letter="W">W</div>
        </div>
    </div>

    <div class="footer">
        Desenvolvido por André Vitor, Sarah Ramos e Julio Cesar
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const processedImage = document.getElementById('processedImage');
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const testConnectionBtn = document.getElementById('testConnectionBtn');
            const detectedLetter = document.getElementById('detectedLetter');
            const recognizedLetter = document.getElementById('recognizedLetter');
            const letterToShow = document.getElementById('letterToShow');
            const alphabetLetters = document.querySelectorAll('.alphabet-letter');
            const cameraStatus = document.getElementById('cameraStatus');
            const errorMessage = document.getElementById('errorMessage');
            const serverStatus = document.getElementById('serverStatus');
            
            let isRunning = false;
            let stream = null;
            let processingInterval = null;
            
            // Verificar status do servidor ao carregar a página
            checkServerStatus();
            
            // Função para verificar o status do servidor
            testConnectionBtn.addEventListener('click', checkServerStatus);
            
            function checkServerStatus() {
                fetch('/status')
                    .then(response => response.json())
                    .then(data => {
                        serverStatus.style.display = 'block';
                        serverStatus.innerHTML = `
                            Servidor conectado! <br>
                            Modelo carregado: ${data.model_loaded ? 'Sim' : 'Não'} <br>
                            Classes disponíveis: ${data.classes ? data.classes.length : 0}
                        `;
                        serverStatus.style.backgroundColor = '#d4edda';
                    })
                    .catch(error => {
                        serverStatus.style.display = 'block';
                        serverStatus.textContent = 'Erro ao conectar com o servidor. Verifique se o serviço está rodando.';
                        serverStatus.style.backgroundColor = '#f8d7da';
                        console.error('Erro ao verificar status do servidor:', error);
                    });
            }
            
            // Função para exibir mensagem de erro
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }
            
            // Função para iniciar a câmera
            startBtn.addEventListener('click', async function() {
                try {
                    // Verificar se o navegador suporta a API MediaDevices
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        showError('Seu navegador não suporta o acesso à câmera. Use um navegador moderno como Chrome, Firefox ou Edge.');
                        return;
                    }
                    
                    // Tentar acessar a câmera
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'user',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        } 
                    });
                    
                    video.srcObject = stream;
                    video.style.display = 'block';
                    
                    startBtn.style.display = 'none';
                    pauseBtn.style.display = 'inline-block';
                    cameraStatus.textContent = 'Câmera ativa';
                    cameraStatus.style.color = '#28a745';
                    
                    isRunning = true;
                    
                    // Iniciar processamento de frames
                    processingInterval = setInterval(processFrame, 200);
                    
                } catch (err) {
                    console.error('Erro ao acessar a câmera:', err);
                    cameraStatus.textContent = 'Erro ao acessar a câmera';
                    cameraStatus.style.color = '#dc3545';
                    
                    // Mensagem de erro mais detalhada
                    if (err.name === 'NotAllowedError') {
                        showError('Permissão para acessar a câmera foi negada. Por favor, permita o acesso à câmera nas configurações do seu navegador.');
                    } else if (err.name === 'NotFoundError') {
                        showError('Nenhuma câmera foi encontrada no seu dispositivo.');
                    } else if (err.name === 'NotReadableError') {
                        showError('A câmera está sendo usada por outro aplicativo.');
                    } else if (err.name === 'OverconstrainedError') {
                        showError('As configurações solicitadas para a câmera não são suportadas.');
                    } else if (err.name === 'SecurityError') {
                        showError('O uso da câmera é bloqueado pela política de segurança.');
                    } else {
                        showError('Erro ao acessar a câmera: ' + err.message);
                    }
                }
            });
            
            // Função para pausar/retomar
            pauseBtn.addEventListener('click', function() {
                if (isRunning) {
                    clearInterval(processingInterval);
                    video.pause();
                    pauseBtn.textContent = 'Retomar';
                    cameraStatus.textContent = 'Câmera pausada';
                    cameraStatus.style.color = '#ffc107';
                    isRunning = false;
                } else {
                    video.play();
                    pauseBtn.textContent = 'Pausar';
                    cameraStatus.textContent = 'Câmera ativa';
                    cameraStatus.style.color = '#28a745';
                    isRunning = true;
                    processingInterval = setInterval(processFrame, 200);
                }
            });
            
            // Função para processar o frame atual
            function processFrame() {
                if (!isRunning || !stream) return;
                
                // Verificar se o vídeo está pronto
                if (video.readyState !== video.HAVE_ENOUGH_DATA) return;
                
                // Configurar o canvas com as dimensões do vídeo
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Desenhar o frame no canvas
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Obter a imagem como base64
                const imageData = canvas.toDataURL('image/jpeg', 0.8); // Comprimir para melhorar desempenho
                
                // Enviar para o backend
                fetch('/process_frame', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: imageData }),
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro no servidor: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        showError('Erro ao processar imagem: ' + data.error);
                        return;
                    }
                    
                    // Atualizar a letra detectada
                    if (data.letter) {
                        detectedLetter.textContent = data.letter;
                        recognizedLetter.textContent = data.letter;
                        
                        // Verificar se a letra detectada corresponde à letra que deve ser praticada
                        const activeLetter = document.querySelector('.alphabet-letter.active');
                        if (activeLetter && activeLetter.dataset.letter === data.letter) {
                            activeLetter.style.backgroundColor = '#28a745';
                            setTimeout(() => {
                                activeLetter.style.backgroundColor = '';
                                activeLetter.classList.add('active');
                            }, 1000);
                        }
                    }
                    
                    // Mostrar a imagem processada se houver
                    if (data.processed_image) {
                        processedImage.src = data.processed_image;
                        processedImage.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Erro ao processar o frame:', error);
                    // Não mostrar todas as mensagens de erro para evitar spam
                    // showError('Erro ao processar imagem. Verifique a conexão com o servidor.');
                });
            }
            
            // Adicionar evento de clique às letras do alfabeto
            alphabetLetters.forEach(letter => {
                letter.addEventListener('click', function() {
                    // Remover a classe 'active' de todas as letras
                    alphabetLetters.forEach(l => {
                        l.classList.remove('active');
                        l.style.backgroundColor = '';
                    });
                    // Adicionar a classe 'active' à letra clicada
                    this.classList.add('active');
                    // Exibir a letra a ser praticada
                    letterToShow.textContent = `Pratique a letra: ${this.dataset.letter}`;
                });
            });
            
            // Limpar recursos ao sair da página
            window.addEventListener('beforeunload', function() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                if (processingInterval) {
                    clearInterval(processingInterval);
                }
            });
        });
    </script>
</body>
</html>
